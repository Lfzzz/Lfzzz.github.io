var timer=null,baggerIntervalFunc=()=>{commentBarrageConfig.barrageList.length&&(popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]),commentBarrageConfig.barrageIndex+=1,commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length),commentBarrageConfig.barrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&removeCommentBarrage(commentBarrageConfig.barrageTimer.shift())};let commentBarrageConfig={lightColors:[["var(--card-bg)","var(--heo-theme)"]],darkColors:[["var(--card-bg)","var(--heo-theme)"]],maxBarrage:1,barrageTime:3e3,twikooUrl:"https://twikoo.dalinzi.club",accessToken:"718c51f064463a12a2332c7007522909",pageUrl:window.location.pathname,barrageTimer:[],barrageList:[],barrageIndex:0,noAvatarType:"retro",dom:document.querySelector(".comment-barrage"),displayBarrage:!1,avatarCDN:"cravatar.cn"};function isInViewPortOfOne(e){if(e){const r=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return e.offsetTop-document.documentElement.scrollTop<=r}return"notPost"}function initCommentBarrage(){var e=JSON.stringify({event:"COMMENT_GET","commentBarrageConfig.accessToken":commentBarrageConfig.accessToken,url:commentBarrageConfig.pageUrl}),r=new XMLHttpRequest;r.withCredentials=!0,r.addEventListener("readystatechange",(function(){4===this.readyState&&(commentBarrageConfig.barrageList=commentLinkFilter(JSON.parse(this.responseText).data),commentBarrageConfig.dom.innerHTML="")})),r.open("POST",commentBarrageConfig.twikooUrl),r.setRequestHeader("Content-Type","application/json"),r.send(e),0==Number(localStorage.getItem("isBarrageToggle"))&&baggerIntervalFunc(),0==Number(localStorage.getItem("isBarrageToggle"))&&(timer=setInterval((()=>{baggerIntervalFunc()}),commentBarrageConfig.barrageTime))}function commentLinkFilter(e){e.sort(((e,r)=>e.created-r.created));let r=[];return e.forEach((e=>{r.push(...getCommentReplies(e))})),r}function getCommentReplies(e){if(e.replies){let r=[e];return e.replies.forEach((e=>{r.push(...getCommentReplies(e))})),r}return[]}function popCommentBarrage(e){let r=document.createElement("div");commentBarrageConfig.dom.clientWidth,commentBarrageConfig.dom.clientHeight;r.className="comment-barrage-item";let a=Math.floor(Math.random()*commentBarrageConfig.lightColors.length);document.getElementById("barragesColor").innerHTML=`[data-theme='light'] .comment-barrage-item { background-color:${commentBarrageConfig.lightColors[a][0]};color:${commentBarrageConfig.lightColors[a][1]}}[data-theme='dark'] .comment-barrage-item{ background-color:${commentBarrageConfig.darkColors[a][0]};color:${commentBarrageConfig.darkColors[a][1]}}`,r.innerHTML=`\n\t\t<div class="barrageHead">\n\t\t\t<img class="barrageAvatar" src="https://${commentBarrageConfig.avatarCDN}/avatar/${e.mailMd5}?d=${commentBarrageConfig.noAvatarType}"/>\n\t\t\t<div class="barrageNick">${e.nick}</div>\n\t\t\t<a href="javascript:switchCommentBarrage()" class="barrageCloseBtn" style="font-size:30px">×</a>\n\t\t</div>\n\t\t<div class="barrageContent">${e.comment}</div>\n\t`,commentBarrageConfig.barrageTimer.push(r),commentBarrageConfig.dom.append(r)}function removeCommentBarrage(e){e.className="comment-barrage-item out",1!=commentBarrageConfig.maxBarrage?setTimeout((()=>{commentBarrageConfig.dom.removeChild(e)}),1e3):commentBarrageConfig.dom&&commentBarrageConfig.dom.removeChild(e)}document.onscroll=function(){commentBarrageConfig.displayBarrage&&(isInViewPortOfOne(document.getElementById("post-comment"))&&"notPost"!=isInViewPortOfOne(document.getElementById("post-comment"))?(document.getElementsByClassName("comment-barrage")[0].setAttribute("style","display:none;"),clearInterval(timer),timer=null):"notPost"==isInViewPortOfOne(document.getElementById("post-comment"))||(timer||0==Number(localStorage.getItem("isBarrageToggle"))&&(timer=setInterval((()=>{baggerIntervalFunc()}),commentBarrageConfig.barrageTime)),document.getElementsByClassName("comment-barrage")[0].setAttribute("style","display:block;")))},switchCommentBarrage=function(){if(localStorage.setItem("isBarrageToggle",1==Number(localStorage.getItem("isBarrageToggle"))?0:1),1==Number(localStorage.getItem("isBarrageToggle"))?(btf.snackbarShow("✨已关闭评论弹窗"),clearInterval(timer),timer=null,document.querySelector(".selfRightMenuBarrage").innerHTML="开启评论弹幕",commentBarrageConfig.displayBarrage=!0):(btf.snackbarShow("✨已开启评论弹窗"),baggerIntervalFunc(),timer||(timer=setInterval((()=>{baggerIntervalFunc()}),commentBarrageConfig.barrageTime)),document.querySelector(".selfRightMenuBarrage").innerHTML="关闭评论弹幕",commentBarrageConfig.displayBarrage=!1,document.getElementsByClassName("comment-barrage")[0].setAttribute("style","display:none;")),!isInViewPortOfOne(document.getElementById("post-comment"))){commentBarrageConfig.displayBarrage=!commentBarrageConfig.displayBarrage;let e=document.querySelector(".comment-barrage");e&&$(e).fadeToggle()}},$(".comment-barrage").hover((function(){clearInterval(timer),timer=null}),(function(){timer||0==Number(localStorage.getItem("isBarrageToggle"))&&(timer=setInterval((()=>{baggerIntervalFunc()}),commentBarrageConfig.barrageTime))})),null==localStorage.getItem("isBarrageToggle")&&localStorage.setItem("isBarrageToggle","0");let initBarrage=()=>{1==Number(localStorage.getItem("isBarrageToggle"))?document.querySelector(".selfRightMenuBarrage").innerHTML="开启评论弹幕":document.querySelector(".selfRightMenuBarrage").innerHTML="关闭评论弹幕",timer&&clearInterval(timer),commentBarrageConfig={lightColors:[["var(--card-bg)","var(--heo-theme)"]],darkColors:[["var(--card-bg)","var(--heo-theme)"]],maxBarrage:1,barrageTime:3e3,twikooUrl:"https://twikoo.dalinzi.club",accessToken:"718c51f064463a12a2332c7007522909",pageUrl:window.location.pathname,barrageTimer:[],barrageList:[],barrageIndex:0,noAvatarType:"retro",dom:document.querySelector(".comment-barrage"),displayBarrage:!0,avatarCDN:"cravatar.cn"},document.querySelector("#body-wrap.post")&&initCommentBarrage(),$(".comment-barrage").hover((function(){clearInterval(timer),timer=null}),(function(){timer||0==Number(localStorage.getItem("isBarrageToggle"))&&(timer=setInterval((()=>{baggerIntervalFunc()}),commentBarrageConfig.barrageTime))})),null==localStorage.getItem("isBarrageToggle")&&localStorage.setItem("isBarrageToggle","0")};window.onload=()=>{initBarrage()},document.addEventListener("pjax:complete",(()=>{initBarrage()}));